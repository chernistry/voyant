<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voyant Metrics Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 20px; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card h2 { color: #555; margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #eee; padding-bottom: 8px; }
        .metric { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .metric:last-child { border-bottom: none; }
        .metric-name { color: #666; }
        .metric-value { font-weight: bold; color: #333; }
        .status { text-align: center; padding: 10px; margin-bottom: 20px; border-radius: 4px; }
        .status.online { background: #d4edda; color: #155724; }
        .status.offline { background: #f8d7da; color: #721c24; }
        .refresh-btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-bottom: 20px; }
        .refresh-btn:hover { background: #0056b3; }
        .auto-refresh { margin-left: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Voyant Travel Assistant - Metrics Dashboard</h1>

        <div id="status" class="status offline">Connecting...</div>

        <button class="refresh-btn" onclick="fetchMetrics()">üîÑ Refresh</button>
        <label class="auto-refresh">
            <input type="checkbox" id="autoRefresh" checked> Auto-refresh (5s)
        </label>

        <div class="grid">
            <div class="card">
                <h2>üìä Chat Activity</h2>
                <div id="chatActivity"></div>
            </div>

            <div class="card">
                <h2>üéØ Router Performance</h2>
                <div id="routerPerf"></div>
            </div>

            <div class="card">
                <h2>‚ùì Clarifications</h2>
                <div id="clarifications"></div>
            </div>

            <div class="card">
                <h2>üîÑ Fallbacks</h2>
                <div id="fallbacks"></div>
            </div>

            <div class="card">
                <h2>üìö Citations & Verification</h2>
                <div id="citations"></div>
            </div>

            <div class="card">
                <h2>üåê External Requests</h2>
                <div id="external"></div>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval;

        function renderMetrics(key, value, container) {
            if (typeof value === 'object' && value !== null) {
                Object.entries(value).forEach(([k, v]) => {
                    container.innerHTML += `<div class="metric"><span class="metric-name">${k}</span><span class="metric-value">${v}</span></div>`;
                });
            } else {
                container.innerHTML += `<div class="metric"><span class="metric-name">${key}</span><span class="metric-value">${value}</span></div>`;
            }
        }

        async function fetchMetrics() {
            try {
                const response = await fetch('/metrics');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                document.getElementById('status').className = 'status online';
                document.getElementById('status').textContent = `‚úÖ Connected - Last updated: ${new Date().toLocaleTimeString()}`;

                // Clear containers
                ['chatActivity', 'routerPerf', 'clarifications', 'fallbacks', 'citations', 'external'].forEach(id => {
                    document.getElementById(id).innerHTML = '';
                });

                // Chat Activity
                const chatDiv = document.getElementById('chatActivity');
                renderMetrics('Total Messages', data.messages_total, chatDiv);
                if (data.chat_turns && Object.keys(data.chat_turns).length > 0) {
                    renderMetrics('chat_turns', data.chat_turns, chatDiv);
                }

                // Router Performance
                const routerDiv = document.getElementById('routerPerf');
                if (data.router_low_conf && Object.keys(data.router_low_conf).length > 0) {
                    renderMetrics('low_confidence', data.router_low_conf, routerDiv);
                } else {
                    routerDiv.innerHTML = '<div class="metric"><span class="metric-name">Low Confidence</span><span class="metric-value">0</span></div>';
                }

                // Clarifications
                const clarifyDiv = document.getElementById('clarifications');
                if (data.clarify_requests && Object.keys(data.clarify_requests).length > 0) {
                    renderMetrics('requests', data.clarify_requests, clarifyDiv);
                }
                if (data.clarify_resolved && Object.keys(data.clarify_resolved).length > 0) {
                    renderMetrics('resolved', data.clarify_resolved, clarifyDiv);
                }
                if (clarifyDiv.innerHTML === '') {
                    clarifyDiv.innerHTML = '<div class="metric"><span class="metric-name">No clarifications yet</span><span class="metric-value">-</span></div>';
                }

                // Fallbacks
                const fallbackDiv = document.getElementById('fallbacks');
                if (data.fallbacks && Object.keys(data.fallbacks).length > 0) {
                    renderMetrics('fallbacks', data.fallbacks, fallbackDiv);
                } else {
                    fallbackDiv.innerHTML = '<div class="metric"><span class="metric-name">No fallbacks yet</span><span class="metric-value">-</span></div>';
                }

                // Citations & Verification
                const citDiv = document.getElementById('citations');
                renderMetrics('With Citations', data.answers_with_citations_total || 0, citDiv);
                if (data.verify_fails && Object.keys(data.verify_fails).length > 0) {
                    renderMetrics('verify_fails', data.verify_fails, citDiv);
                }

                // External Requests
                const extDiv = document.getElementById('external');
                if (data.external_requests && data.external_requests.targets.length > 0) {
                    data.external_requests.targets.forEach(target => {
                        extDiv.innerHTML += `<div class="metric"><span class="metric-name">${target.target}</span><span class="metric-value">${target.total} (${target.latency.avg_ms}ms avg)</span></div>`;
                    });
                } else {
                    extDiv.innerHTML = '<div class="metric"><span class="metric-name">No external requests yet</span><span class="metric-value">-</span></div>';
                }

            } catch (error) {
                document.getElementById('status').className = 'status offline';
                document.getElementById('status').textContent = `‚ùå Error: ${error.message}`;
            }
        }

        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            if (checkbox.checked) {
                autoRefreshInterval = setInterval(fetchMetrics, 5000);
            } else {
                clearInterval(autoRefreshInterval);
            }
        }

        document.getElementById('autoRefresh').addEventListener('change', toggleAutoRefresh);

        // Initial load
        fetchMetrics();
        toggleAutoRefresh();
    </script>
</body>
</html>
