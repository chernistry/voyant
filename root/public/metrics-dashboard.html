<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voyant Metrics Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 20px; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card h2 { color: #555; margin-bottom: 10px; font-size: 18px; border-bottom: 2px solid #eee; padding-bottom: 8px; }
        .hint { font-size: 13px; color: #7a7a7a; margin-bottom: 12px; line-height: 1.4; }
        .metric { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .metric:last-child { border-bottom: none; }
        .metric-name { color: #666; }
        .metric-value { font-weight: bold; color: #333; }
        .status { text-align: center; padding: 10px; margin-bottom: 20px; border-radius: 4px; }
        .status.online { background: #d4edda; color: #155724; }
        .status.offline { background: #f8d7da; color: #721c24; }
        .refresh-btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-bottom: 20px; }
        .refresh-btn:hover { background: #0056b3; }
        .auto-refresh { margin-left: 10px; }
        .alert { color: #721c24; }
        .warn { color: #856404; }
        .ok { color: #155724; }
        .spark { font-family: monospace; letter-spacing: 1px; color: #333; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Voyant Travel Assistant - Metrics Dashboard</h1>
        <p class="hint" style="text-align:center; max-width:760px; margin:0 auto 18px;">
            These cards answer two interview-critical questions: are answers grounded and helpful, and do we route/clarify fast enough to keep users happy?
        </p>

        <div id="status" class="status offline">Connecting...</div>

        <button class="refresh-btn" onclick="fetchMetrics()">üîÑ Refresh</button>
        <label class="auto-refresh">
            <input type="checkbox" id="autoRefresh" checked> Auto-refresh (5s)
        </label>

        <div class="grid">
            <div class="card">
                <h2>üèÅ Business Overview</h2>
                <p class="hint">FCR reveals how often we resolve without escalation, while TTR (avg ms) shows how quickly intents finish.</p>
                <div id="business"></div>
            </div>
            <div class="card">
                <h2>üìä Chat Activity</h2>
                <p class="hint">Turns per intent highlight demand hot-spots; sudden spikes often correlate with new features or regressions.</p>
                <div id="chatActivity"></div>
            </div>

            <div class="card">
                <h2>üéØ Router Performance</h2>
                <p class="hint">Low-confidence routes are early warning for off-topic replies or intents that need better training.</p>
                <div id="routerPerf"></div>
            </div>

            <div class="card">
                <h2>‚ùì Clarifications</h2>
                <p class="hint">Compare clarify requests vs resolved to confirm we collect missing slots instead of leaving users stuck.</p>
                <div id="clarifications"></div>
            </div>

            <div class="card">
                <h2>üîÑ Fallbacks</h2>
                <p class="hint">Web or browser fallback surges signal gaps in API coverage or flaky upstreams; investigate prolonged increases.</p>
                <div id="fallbacks"></div>
            </div>

            <div class="card">
                <h2>üìö Citations & Verification</h2>
                <p class="hint">Citation coverage and verify pass rate are our north-star for grounded answers from web search or RAG.</p>
                <div id="citations"></div>
            </div>

            <div class="card">
                <h2>üåê External Requests</h2>
                <p class="hint">Latency and status per target expose tool reliability‚Äîwatch for slow Brave/Tavily responses that erode relevance.</p>
                <div id="external"></div>
            </div>

            <div class="card">
                <h2>‚ö° Performance</h2>
                <p class="hint">E2E latency buckets keep us honest on UX; p95 should stay under the 3‚Äì6s band depending on cache/fresh data.</p>
                <div id="perf"></div>
            </div>

            <div class="card">
                <h2>üß∞ Tool Reliability</h2>
                <p class="hint">Timeout rate and calls/turn help spot flaky providers and chat-tool churn.</p>
                <div id="tools"></div>
            </div>

            <div class="card">
                <h2>‚ö†Ô∏è Alerts</h2>
                <p class="hint">Threshold-based warnings derived from SLO targets.</p>
                <div id="alerts"></div>
            </div>

            <div class="card">
                <h2>üìà Trends</h2>
                <p class="hint">Last 30 samples (auto-refresh) for key KPIs.</p>
                <div id="trends"></div>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval;
        const history = {
            e2e_avg_ms: [],
            fcr_rate: [],
            verify_fail_rate: []
        };

        function pushHistory(key, value) {
            if (typeof value !== 'number' || !isFinite(value)) return;
            const arr = history[key] || (history[key] = []);
            arr.push(value);
            if (arr.length > 30) arr.shift();
        }

        function sparkline(values) {
            if (!values || values.length === 0) return '';
            const blocks = ['‚ñÅ','‚ñÇ','‚ñÉ','‚ñÑ','‚ñÖ','‚ñÜ','‚ñá','‚ñà'];
            const min = Math.min(...values);
            const max = Math.max(...values);
            const range = max - min || 1;
            return values.map(v => {
                const idx = Math.min(blocks.length - 1, Math.max(0, Math.floor(((v - min) / range) * (blocks.length - 1))));
                return blocks[idx];
            }).join('');
        }

        function renderMetrics(key, value, container) {
            if (typeof value === 'object' && value !== null) {
                Object.entries(value).forEach(([k, v]) => {
                    container.innerHTML += `<div class="metric"><span class="metric-name">${k}</span><span class="metric-value">${v}</span></div>`;
                });
            } else {
                container.innerHTML += `<div class="metric"><span class="metric-name">${key}</span><span class="metric-value">${value}</span></div>`;
            }
        }

        async function fetchMetrics() {
            try {
                const response = await fetch('/metrics');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                document.getElementById('status').className = 'status online';
                document.getElementById('status').textContent = `‚úÖ Connected - Last updated: ${new Date().toLocaleTimeString()}`;

                // Clear containers
                ['business','chatActivity', 'routerPerf', 'clarifications', 'fallbacks', 'citations', 'external', 'perf', 'tools', 'alerts', 'trends'].forEach(id => {
                    document.getElementById(id).innerHTML = '';
                });

                // Business Overview
                const bizDiv = document.getElementById('business');
                if (data.business) {
                    renderMetrics('total_sessions', data.business.total_sessions || 0, bizDiv);
                    renderMetrics('resolved_sessions', data.business.resolved_sessions || 0, bizDiv);
                    renderMetrics('fcr_rate', data.business.fcr_rate || 0, bizDiv);
                    if (typeof data.business.deflection_rate === 'number') {
                        renderMetrics('deflection_rate', data.business.deflection_rate, bizDiv);
                    }
                    if (data.business.session_outcomes) {
                        renderMetrics('outcomes', data.business.session_outcomes, bizDiv);
                    }
                    if (data.business.ttr_ms_by_intent) {
                        const ttrView = {};
                        for (const [k,v] of Object.entries(data.business.ttr_ms_by_intent)) {
                            // show avg_ms per intent
                            // @ts-ignore
                            ttrView[k] = (v && v.avg_ms) ? v.avg_ms : 0;
                        }
                        renderMetrics('ttr_avg_ms{intent}', ttrView, bizDiv);
                    }
                } else {
                    bizDiv.innerHTML = '<div class="metric"><span class="metric-name">Sessions</span><span class="metric-value">No data</span></div>';
                }

                // Chat Activity
                const chatDiv = document.getElementById('chatActivity');
                renderMetrics('Total Messages', data.messages_total, chatDiv);
                if (data.chat_turns && Object.keys(data.chat_turns).length > 0) {
                    renderMetrics('chat_turns', data.chat_turns, chatDiv);
                }

                // Router Performance
                const routerDiv = document.getElementById('routerPerf');
                if (data.router_low_conf && Object.keys(data.router_low_conf).length > 0) {
                    renderMetrics('low_confidence', data.router_low_conf, routerDiv);
                } else {
                    routerDiv.innerHTML = '<div class="metric"><span class="metric-name">Low Confidence</span><span class="metric-value">0</span></div>';
                }
                if (data.router_confidence_buckets) {
                    renderMetrics('confidence_buckets', data.router_confidence_buckets, routerDiv);
                }

                // Clarifications
                const clarifyDiv = document.getElementById('clarifications');
                if (data.clarify_requests && Object.keys(data.clarify_requests).length > 0) {
                    renderMetrics('requests', data.clarify_requests, clarifyDiv);
                }
                if (data.clarify_resolved && Object.keys(data.clarify_resolved).length > 0) {
                    renderMetrics('resolved', data.clarify_resolved, clarifyDiv);
                }
                if (clarifyDiv.innerHTML === '') {
                    clarifyDiv.innerHTML = '<div class="metric"><span class="metric-name">No clarifications yet</span><span class="metric-value">-</span></div>';
                }

                // Fallbacks
                const fallbackDiv = document.getElementById('fallbacks');
                if (data.fallbacks && Object.keys(data.fallbacks).length > 0) {
                    renderMetrics('fallbacks', data.fallbacks, fallbackDiv);
                } else {
                    fallbackDiv.innerHTML = '<div class="metric"><span class="metric-name">No fallbacks yet</span><span class="metric-value">-</span></div>';
                }

                // Citations & Verification
                const citDiv = document.getElementById('citations');
                renderMetrics('With Citations', data.answers_with_citations_total || 0, citDiv);
                if (typeof data.answers_using_external_data_total === 'number') {
                    renderMetrics('answers_using_external', data.answers_using_external_data_total, citDiv);
                }
                if (data.quality) {
                    renderMetrics('verify_pass_rate', data.quality.verify_pass_rate || 0, citDiv);
                    if (typeof data.quality.verify_fail_rate === 'number') {
                        renderMetrics('verify_fail_rate', data.quality.verify_fail_rate, citDiv);
                    }
                    renderMetrics('citation_coverage', data.quality.citation_coverage || 0, citDiv);
                    if (typeof data.quality.clarification_efficacy === 'number') {
                        renderMetrics('clarification_efficacy', data.quality.clarification_efficacy, citDiv);
                    }
                }
                if (data.verify_fails && Object.keys(data.verify_fails).length > 0) {
                    renderMetrics('verify_fails', data.verify_fails, citDiv);
                }

                // External Requests
                const extDiv = document.getElementById('external');
                if (data.external_requests && data.external_requests.targets.length > 0) {
                    data.external_requests.targets.forEach(target => {
                        const tr = (typeof target.timeout_rate === 'number') ? `, timeout ${Math.round(target.timeout_rate*100)}%` : '';
                        extDiv.innerHTML += `<div class="metric"><span class="metric-name">${target.target}</span><span class="metric-value">${target.total} (${target.latency.avg_ms}ms avg${tr})</span></div>`;
                    });
                } else {
                    extDiv.innerHTML = '<div class="metric"><span class="metric-name">No external requests yet</span><span class="metric-value">-</span></div>';
                }

                // Performance
                const perfDiv = document.getElementById('perf');
                if (data.performance && data.performance.e2e_latency_ms) {
                    renderMetrics('e2e_avg_ms', data.performance.e2e_latency_ms.avg_ms || 0, perfDiv);
                    renderMetrics('e2e_pmin_ms', data.performance.e2e_latency_ms.min_ms || 0, perfDiv);
                    renderMetrics('e2e_pmax_ms', data.performance.e2e_latency_ms.max_ms || 0, perfDiv);
                    if (data.performance.e2e_latency_ms.buckets) {
                        renderMetrics('e2e_buckets_ms', data.performance.e2e_latency_ms.buckets, perfDiv);
                    }
                    if (typeof data.performance.tool_calls_per_turn === 'number') {
                        renderMetrics('tool_calls_per_turn', data.performance.tool_calls_per_turn, perfDiv);
                    }
                } else {
                    perfDiv.innerHTML = '<div class="metric"><span class="metric-name">E2E Latency</span><span class="metric-value">No data</span></div>';
                }

                // Tools
                const toolsDiv = document.getElementById('tools');
                if (data.external_requests && data.external_requests.targets.length > 0) {
                    const totals = data.external_requests.targets.reduce((acc, t) => acc + (t.total || 0), 0);
                    renderMetrics('total_tool_calls', totals, toolsDiv);
                    data.external_requests.targets.forEach(t => {
                        const rate = typeof t.timeout_rate === 'number' ? Math.round(t.timeout_rate * 100) + '%' : 'n/a';
                        toolsDiv.innerHTML += `<div class="metric"><span class="metric-name">${t.target} timeout</span><span class="metric-value">${rate}</span></div>`;
                    });
                } else {
                    toolsDiv.innerHTML = '<div class="metric"><span class="metric-name">No tool data</span><span class="metric-value">-</span></div>';
                }

                // Alerts (simple SLOs)
                const alertsDiv = document.getElementById('alerts');
                const alerts = [];
                const e2eAvg = data?.performance?.e2e_latency_ms?.avg_ms || 0;
                const vfr = data?.quality?.verify_fail_rate || 0;
                const fcr = data?.business?.fcr_rate || 0;
                const timeoutBreaches = (data?.external_requests?.targets || []).filter(t => (t.timeout_rate || 0) > 0.02);
                if (e2eAvg > 6000) alerts.push(['E2E latency > 6s', 'alert']);
                else if (e2eAvg > 3000) alerts.push(['E2E latency > 3s', 'warn']);
                if (vfr > 0.05) alerts.push(['Verify fail rate > 5%', 'alert']);
                if (fcr < 0.6 && (data.business?.total_sessions || 0) >= 5) alerts.push(['FCR < 0.60', 'warn']);
                timeoutBreaches.forEach(t => alerts.push([`${t.target} timeout > 2%`, 'alert']));
                if (alerts.length === 0) alerts.push(['All SLOs within targets', 'ok']);
                alerts.forEach(([msg, level]) => {
                    alertsDiv.innerHTML += `<div class="metric"><span class="metric-name ${level}">${msg}</span><span class="metric-value"></span></div>`;
                });

                // Trends
                const trendsDiv = document.getElementById('trends');
                pushHistory('e2e_avg_ms', e2eAvg);
                pushHistory('fcr_rate', fcr);
                pushHistory('verify_fail_rate', vfr);
                trendsDiv.innerHTML += `<div class="metric"><span class="metric-name">e2e_avg_ms</span><span class="metric-value spark">${sparkline(history.e2e_avg_ms)}</span></div>`;
                trendsDiv.innerHTML += `<div class="metric"><span class="metric-name">fcr_rate</span><span class="metric-value spark">${sparkline(history.fcr_rate)}</span></div>`;
                trendsDiv.innerHTML += `<div class="metric"><span class="metric-name">verify_fail_rate</span><span class="metric-value spark">${sparkline(history.verify_fail_rate)}</span></div>`;

            } catch (error) {
                document.getElementById('status').className = 'status offline';
                document.getElementById('status').textContent = `‚ùå Error: ${error.message}`;
            }
        }

        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            if (checkbox.checked) {
                autoRefreshInterval = setInterval(fetchMetrics, 5000);
            } else {
                clearInterval(autoRefreshInterval);
            }
        }

        document.getElementById('autoRefresh').addEventListener('change', toggleAutoRefresh);

        // Initial load
        fetchMetrics();
        toggleAutoRefresh();
    </script>
</body>
</html>
