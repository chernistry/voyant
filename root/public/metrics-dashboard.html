<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voyant Metrics Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-bxMPr4HbtX0iC4d2TPV5KT9fSx7XDyEL6pF5M6IwQlGRf8bOiE7PJUID4nPrcB8V3gMbdvO1uC13Bscx1Ax7mw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root {
      --color-bg: #f4f6fa;
      --color-surface: #ffffff;
      --color-border: #e4e7ec;
      --color-neutral: #667085;
      --color-muted: #8a93a4;
      --color-heading: #1d2736;
      --color-primary: #2563eb;
      --color-primary-dark: #1d4ed8;
      --color-positive: #12b76a;
      --color-warning: #f79009;
      --color-critical: #f04438;
      --color-info: #3b82f6;
      --shadow-sm: 0 8px 16px rgba(15, 23, 42, 0.04);
      --shadow-lg: 0 16px 40px rgba(15, 23, 42, 0.1);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--color-bg);
      color: var(--color-heading);
      -webkit-font-smoothing: antialiased;
    }

    .dashboard {
      max-width: 1240px;
      margin: 0 auto;
      padding: 24px 24px 72px;
      display: flex;
      flex-direction: column;
      gap: 32px;
    }

    .app-header {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      padding: 20px 28px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      border: 1px solid var(--color-border);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .brand__icon {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      color: #fff;
      display: grid;
      place-items: center;
      font-size: 22px;
      box-shadow: var(--shadow-sm);
    }

    .brand__title {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .brand__title span {
      color: var(--color-primary);
    }

    .header-actions {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 16px;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      border-radius: 999px;
      font-weight: 500;
      background: rgba(37, 99, 235, 0.08);
      color: var(--color-primary);
      border: 1px solid rgba(37, 99, 235, 0.16);
      transition: background 0.2s ease, color 0.2s ease, border 0.2s ease;
    }

    .status-pill--warn {
      background: rgba(247, 144, 9, 0.12);
      color: var(--color-warning);
      border-color: rgba(247, 144, 9, 0.24);
    }

    .status-pill--critical {
      background: rgba(240, 68, 56, 0.12);
      color: var(--color-critical);
      border-color: rgba(240, 68, 56, 0.24);
    }

    .status-pill__dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: currentColor;
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
    }

    .status-pill--warn .status-pill__dot {
      box-shadow: 0 0 0 4px rgba(247, 144, 9, 0.12);
    }

    .status-pill--critical .status-pill__dot {
      box-shadow: 0 0 0 4px rgba(240, 68, 56, 0.12);
    }

    .header-actions__group {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .timestamp {
      font-size: 14px;
      color: var(--color-muted);
    }

    .button {
      appearance: none;
      border: none;
      border-radius: 999px;
      padding: 10px 20px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .button--primary {
      background: var(--color-primary);
      color: #fff;
      box-shadow: 0 10px 18px rgba(37, 99, 235, 0.18);
    }

    .button--primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 22px rgba(37, 99, 235, 0.22);
      background: var(--color-primary-dark);
    }

    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--color-neutral);
      cursor: pointer;
      user-select: none;
    }

    .toggle input {
      width: 18px;
      height: 18px;
      accent-color: var(--color-primary);
      cursor: pointer;
    }

    .app-content {
      display: flex;
      flex-direction: column;
      gap: 32px;
    }

    .section {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: 24px 28px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--color-border);
    }

    .section__header {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 20px;
    }

    .section__title {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .section__subtitle {
      font-size: 14px;
      color: var(--color-neutral);
      max-width: 720px;
    }

    .summary-grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .summary-card {
      padding: 18px;
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border);
      background: linear-gradient(180deg, rgba(37, 99, 235, 0.03) 0%, rgba(37, 99, 235, 0.0) 100%);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .summary-card--positive {
      background: linear-gradient(180deg, rgba(18, 183, 106, 0.06) 0%, rgba(18, 183, 106, 0.02) 100%);
      border-color: rgba(18, 183, 106, 0.18);
    }

    .summary-card--critical {
      background: linear-gradient(180deg, rgba(240, 68, 56, 0.08) 0%, rgba(240, 68, 56, 0.03) 100%);
      border-color: rgba(240, 68, 56, 0.2);
    }

    .summary-card__label {
      font-size: 13px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--color-muted);
    }

    .summary-card__value {
      font-size: 26px;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    .summary-card__caption {
      font-size: 13px;
      color: var(--color-neutral);
    }

    .alerts-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .alert-item {
      border-radius: var(--radius-md);
      padding: 14px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      border: 1px solid rgba(240, 68, 56, 0.24);
      background: rgba(240, 68, 56, 0.08);
      color: var(--color-critical);
    }

    .alert-item--warn {
      border-color: rgba(247, 144, 9, 0.24);
      background: rgba(247, 144, 9, 0.08);
      color: var(--color-warning);
    }

    .alert-item__label {
      font-weight: 600;
    }

    .pipeline-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 18px;
    }

    .pipeline-card {
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      background: #fbfdff;
    }

    .pipeline-card__title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .pipeline-card__stage {
      font-weight: 600;
      font-size: 16px;
    }

    .pipeline-card__meta {
      font-size: 13px;
      color: var(--color-neutral);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .progress {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .progress__bar {
      flex: 1;
      height: 8px;
      background: rgba(37, 99, 235, 0.12);
      border-radius: 999px;
      overflow: hidden;
      position: relative;
    }

    .progress__value {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      background: var(--color-primary);
      border-radius: 999px;
      transition: width 0.3s ease;
    }

    .progress--warn .progress__value {
      background: var(--color-warning);
    }

    .progress--critical .progress__value {
      background: var(--color-critical);
    }

    .progress__label {
      font-size: 13px;
      font-weight: 600;
    }

    .metric-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid rgba(226, 232, 240, 0.6);
    }

    .metric-row:last-child {
      border-bottom: none;
    }

    .metric-row__label {
      font-size: 14px;
      font-weight: 500;
      color: var(--color-heading);
    }

    .metric-row__value {
      font-size: 14px;
      font-weight: 600;
    }

    .metric-row--positive .metric-row__value {
      color: var(--color-positive);
    }

    .metric-row--warn .metric-row__value {
      color: var(--color-warning);
    }

    .metric-row--critical .metric-row__value {
      color: var(--color-critical);
    }

    .panel-grid {
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .panel {
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      background: #fff;
    }

    .panel__title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 15px;
      font-weight: 600;
      color: var(--color-heading);
    }

    .panel__description {
      font-size: 13px;
      color: var(--color-neutral);
    }

    .empty-state {
      padding: 16px;
      border-radius: var(--radius-md);
      border: 1px dashed var(--color-border);
      text-align: center;
      font-size: 14px;
      color: var(--color-neutral);
      background: #fafbfc;
    }

    .guide {
      border-radius: var(--radius-md);
      background: #f8fafc;
      padding: 18px;
      border: 1px solid var(--color-border);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .guide__title {
      font-weight: 600;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .guide__steps {
      display: grid;
      gap: 10px;
    }

    .guide-step {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      font-size: 13px;
      color: var(--color-neutral);
    }

    .guide-step__badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(37, 99, 235, 0.12);
      color: var(--color-primary);
      font-weight: 600;
      font-size: 12px;
    }

    footer {
      text-align: center;
      font-size: 13px;
      color: var(--color-neutral);
      padding: 24px 0 48px;
    }

    @media (max-width: 768px) {
      .dashboard {
        padding: 16px 16px 56px;
      }

      .app-header {
        padding: 18px;
      }

      .section {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <header class="app-header">
      <div class="brand" aria-label="Voyant Metrics">
        <div class="brand__icon" aria-hidden="true">
          <i class="fas fa-chart-line"></i>
        </div>
        <div class="brand__title">Voyant<span>Metrics</span></div>
      </div>
      <div class="header-actions">
        <div class="status-pill" id="statusPill" role="status" aria-live="polite">
          <span class="status-pill__dot" aria-hidden="true"></span>
          <span class="status-pill__label" id="statusLabel">Connecting…</span>
        </div>
        <div class="header-actions__group">
          <span class="timestamp" id="lastUpdated">Last updated —</span>
          <button class="button button--primary" id="refreshBtn" type="button">
            <i class="fas fa-rotate"></i>
            <span>Refresh data</span>
          </button>
          <label class="toggle" for="autoRefresh">
            <input type="checkbox" id="autoRefresh" name="autoRefresh" checked />
            <span>Auto-refresh</span>
          </label>
        </div>
      </div>
    </header>

    <main class="app-content">
      <section class="section" aria-labelledby="summary-title">
        <div class="section__header">
          <h2 class="section__title" id="summary-title">Executive overview</h2>
          <p class="section__subtitle">Enterprise snapshot across pipeline, search, and customer-facing latency.</p>
        </div>
        <div class="summary-grid" id="summaryGrid"></div>
      </section>

      <section class="section" aria-labelledby="alerts-title">
        <div class="section__header">
          <h2 class="section__title" id="alerts-title">Active alerts</h2>
          <p class="section__subtitle">Immediate issues that require attention across the production stack.</p>
        </div>
        <div class="alerts-list" id="alertsList"></div>
      </section>

      <section class="section" aria-labelledby="pipeline-title" data-section="pipeline">
        <div class="section__header">
          <h2 class="section__title" id="pipeline-title">Pipeline health</h2>
          <p class="section__subtitle">Success rate, latency, and throughput by stage/intent. Investigate cards in red first.</p>
        </div>
        <div class="pipeline-grid" id="pipelineGrid"></div>
      </section>

      <section class="section" aria-labelledby="meta-title">
        <div class="section__header">
          <h2 class="section__title" id="meta-title">Meta Agent</h2>
          <p class="section__subtitle">Routing confidence, tool usage/errors, tokens, and LLM latency.</p>
        </div>
        <div class="panel-grid">
          <article class="panel" aria-label="Routing & tokens">
            <header class="panel__title"><i class="fas fa-route"></i>Routing & tokens</header>
            <div class="metric-list" id="metaRouting"></div>
          </article>
          <article class="panel" aria-label="Tool usage & errors">
            <header class="panel__title"><i class="fas fa-wrench"></i>Tool usage & errors</header>
            <div class="metric-list" id="metaTools"></div>
          </article>
          <article class="panel" aria-label="LLM latency">
            <header class="panel__title"><i class="fas fa-brain"></i>LLM latency</header>
            <div class="metric-list" id="metaLLM"></div>
          </article>
        </div>
      </section>

      <section class="section" aria-labelledby="quality-title">
        <div class="section__header">
          <h2 class="section__title" id="quality-title">Conversation quality & safety</h2>
          <p class="section__subtitle">Monitor classifier accuracy, verification success, and confidence calibration.</p>
        </div>
        <div class="panel-grid">
          <article class="panel" aria-label="Conversation metrics">
            <header class="panel__title"><i class="fas fa-comments"></i>Conversation outcomes</header>
            <p class="panel__description">Key quality KPIs across content classification, escalation reasons, and receipts.</p>
            <div class="metric-list" id="conversationMetrics"></div>
          </article>
          <article class="panel" aria-label="Confidence correlation">
            <header class="panel__title"><i class="fas fa-signal"></i>Confidence correlation</header>
            <p class="panel__description">Compare success rates for high/low confidence routes to validate routing thresholds.</p>
            <div class="metric-list" id="confidenceMetrics"></div>
          </article>
          <article class="panel" aria-label="Search quality">
            <header class="panel__title"><i class="fas fa-search"></i>Search quality</header>
            <p class="panel__description">Usage, upgrade rate, and complexity mix across Brave/Tavily and deep research.</p>
            <div class="metric-list" id="searchMetrics"></div>
          </article>
        </div>
      </section>

      <section class="section" aria-labelledby="operations-title">
        <div class="section__header">
          <h2 class="section__title" id="operations-title">Operational readiness</h2>
          <p class="section__subtitle">External dependencies, system latency, and resilience signals.</p>
        </div>
        <div class="panel-grid">
          <article class="panel" aria-label="External APIs">
            <header class="panel__title"><i class="fas fa-globe"></i>External partners</header>
            <div class="metric-list" id="externalMetrics"></div>
          </article>
          <article class="panel" aria-label="Performance">
            <header class="panel__title"><i class="fas fa-tachometer-alt"></i>Response performance</header>
            <div class="metric-list" id="performanceMetrics"></div>
          </article>
          <article class="panel" aria-label="Platform controls">
            <header class="panel__title"><i class="fas fa-toolbox"></i>Platform controls</header>
            <div class="metric-list" id="systemMetrics"></div>
          </article>
        </div>
      </section>

      <section class="section" aria-labelledby="playbook-title">
        <div class="section__header">
          <h2 class="section__title" id="playbook-title">Response playbook</h2>
          <p class="section__subtitle">Use this sequence when metrics degrade to keep debugging conversations consistent across teams.</p>
        </div>
        <div class="guide">
          <div class="guide__title"><i class="fas fa-route"></i>Operational flow</div>
          <div class="guide__steps">
            <div class="guide-step">
              <span class="guide-step__badge">1</span>
              <span>Start with <strong>Pipeline health</strong>. Confirm which stage or intent is degrading via success rate and latency.</span>
            </div>
            <div class="guide-step">
              <span class="guide-step__badge">2</span>
              <span>Review <strong>Conversation quality</strong> cards to isolate classifier accuracy, verification failures, or safety escalations.</span>
            </div>
            <div class="guide-step">
              <span class="guide-step__badge">3</span>
              <span>Inspect <strong>Operational readiness</strong> to validate partner APIs, rate limits, and circuit breakers before escalating.</span>
            </div>
            <div class="guide-step">
              <span class="guide-step__badge">4</span>
              <span>Log remediation steps in the incident tracker. Re-run refresh once mitigations are deployed.</span>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      © <span id="footerYear"></span> Navan · Built for production observability and on-call readiness
    </footer>
  </div>

  <script>
    const API_ENDPOINT = '/metrics';
    const REFRESH_INTERVAL_MS = 5000;

    const els = {
      statusPill: document.getElementById('statusPill'),
      statusLabel: document.getElementById('statusLabel'),
      lastUpdated: document.getElementById('lastUpdated'),
      summary: document.getElementById('summaryGrid'),
      alerts: document.getElementById('alertsList'),
      pipeline: document.getElementById('pipelineGrid'),
      metaRouting: document.getElementById('metaRouting'),
      metaTools: document.getElementById('metaTools'),
      metaLLM: document.getElementById('metaLLM'),
      conversation: document.getElementById('conversationMetrics'),
      confidence: document.getElementById('confidenceMetrics'),
      search: document.getElementById('searchMetrics'),
      external: document.getElementById('externalMetrics'),
      performance: document.getElementById('performanceMetrics'),
      system: document.getElementById('systemMetrics'),
      autoRefresh: document.getElementById('autoRefresh'),
      refreshBtn: document.getElementById('refreshBtn')
    };

    let autoRefreshTimer;

    function formatPercent(value, fractionDigits = 1) {
      if (value === undefined || value === null || Number.isNaN(value)) return '—';
      return `${(value * 100).toFixed(fractionDigits)}%`;
    }

    function formatNumber(value) {
      if (value === undefined || value === null || Number.isNaN(value)) return '—';
      return value.toLocaleString();
    }

    function formatMilliseconds(value) {
      if (value === undefined || value === null || Number.isNaN(value)) return '—';
      return `${Math.round(value).toLocaleString()} ms`;
    }

    function clearNode(node) {
      while (node.firstChild) {
        node.removeChild(node.firstChild);
      }
    }

    function setStatus(state, message) {
      els.statusPill.classList.remove('status-pill--warn', 'status-pill--critical');
      if (state === 'ok') {
        els.statusLabel.textContent = message || 'Connected';
      } else if (state === 'warn') {
        els.statusPill.classList.add('status-pill--warn');
        els.statusLabel.textContent = message || 'Degraded';
      } else if (state === 'critical') {
        els.statusPill.classList.add('status-pill--critical');
        els.statusLabel.textContent = message || 'Unavailable';
      } else {
        els.statusLabel.textContent = message || 'Connecting…';
      }
    }

    function renderEmpty(container, message) {
      clearNode(container);
      const empty = document.createElement('div');
      empty.className = 'empty-state';
      empty.textContent = message;
      container.appendChild(empty);
    }

    function createMetricRow(label, value, tone) {
      const row = document.createElement('div');
      row.className = 'metric-row';
      if (tone) {
        row.classList.add(`metric-row--${tone}`);
      }
      const labelEl = document.createElement('span');
      labelEl.className = 'metric-row__label';
      labelEl.textContent = label;
      const valueEl = document.createElement('span');
      valueEl.className = 'metric-row__value';
      valueEl.textContent = value;
      row.append(labelEl, valueEl);
      return row;
    }

    function adaptLegacyPayload(payload) {
      if (!payload || (payload.pipeline && Array.isArray(payload.pipeline.stages))) {
        const normalized = payload || {};
        if (normalized.quality && !Array.isArray(normalized.quality.conversation)) {
          normalized.quality.conversation = [];
        }
        return normalized;
      }

      const legacy = payload || {};

      // Pipeline
      let pipelineRaw = [];
      if (Array.isArray(legacy.pipeline_stages)) {
        pipelineRaw = legacy.pipeline_stages;
      } else if (legacy.pipeline && Array.isArray(legacy.pipeline.stages)) {
        pipelineRaw = legacy.pipeline.stages;
      }

      const pipelineStages = pipelineRaw.map((stage) => {
        const key = stage.stage || '';
        const parts = key.split('_');
        const stageName = parts[0] || 'unknown';
        const intent = parts.slice(1).join('_') || (stage.intent || '');
        const totalsLegacy = stage.totals || {};
        const totals = {
          success: stage.success_count || totalsLegacy.success || 0,
          clarify: stage.clarify_count || totalsLegacy.clarify || 0,
          fail: stage.failure_count || totalsLegacy.fail || 0,
          escalated: stage.escalated_count || totalsLegacy.escalated || 0
        };
        const latencyBlock = stage.latency || {};
        return {
          stage: stageName,
          intent,
          totals,
          latency: {
            p95: typeof latencyBlock.p95 === 'number' ? latencyBlock.p95 : 0,
            avg_ms: latencyBlock.avg_ms,
            max_ms: latencyBlock.max_ms,
            min_ms: latencyBlock.min_ms
          }
        };
      });

      let pipelineAlerts = [];
      if (legacy.pipeline && Array.isArray(legacy.pipeline.alerts)) {
        pipelineAlerts = legacy.pipeline.alerts;
      } else if (Array.isArray(legacy.alerts)) {
        pipelineAlerts = legacy.alerts;
      }

      // Quality metrics
      const qualityStats = legacy.quality || {};
      const conversationMetrics = [];

      if (typeof qualityStats.verify_pass_rate === 'number') {
        conversationMetrics.push({
          label: 'Verify pass rate',
          value: qualityStats.verify_pass_rate,
          format: 'percent',
          tone: qualityStats.verify_pass_rate >= 0.9 ? 'positive' : qualityStats.verify_pass_rate < 0.8 ? 'critical' : ''
        });
      }
      if (typeof qualityStats.verify_fail_rate === 'number') {
        conversationMetrics.push({
          label: 'Verify fail rate',
          value: qualityStats.verify_fail_rate,
          format: 'percent',
          tone: qualityStats.verify_fail_rate > 0.15 ? 'critical' : ''
        });
      }
      if (typeof qualityStats.citation_coverage === 'number') {
        conversationMetrics.push({
          label: 'Citation coverage',
          value: qualityStats.citation_coverage,
          format: 'percent',
          tone: qualityStats.citation_coverage >= 0.8 ? 'positive' : ''
        });
      }
      if (typeof qualityStats.clarification_efficacy === 'number') {
        conversationMetrics.push({
          label: 'Clarification efficacy',
          value: qualityStats.clarification_efficacy,
          format: 'percent'
        });
      }

      let confidenceRaw = [];
      if (Array.isArray(legacy.confidence_correlation)) {
        confidenceRaw = legacy.confidence_correlation;
      } else if (Array.isArray(qualityStats.confidence)) {
        confidenceRaw = qualityStats.confidence;
      }

      const confidenceMetrics = confidenceRaw.map((entry) => ({
        stage: entry.stage || 'unknown',
        intent: entry.intent || '',
        high: entry.high || entry.high_confidence || { total: 0, success_rate: 0 },
        low: entry.low || entry.low_confidence || { total: 0, success_rate: 0 }
      }));

      // Search metrics
      const searchLegacy = legacy.search || legacy.search_quality || {};
      const toNumber = (value) => {
        if (typeof value === 'number') return value;
        if (typeof value === 'string' && value.trim() !== '') {
          const parsed = parseFloat(value);
          return Number.isNaN(parsed) ? undefined : parsed;
        }
        return undefined;
      };

      const searchMetrics = {
        total: searchLegacy.total || searchLegacy.total_searches || 0,
        complex_query_rate: (function () {
          const first = toNumber(searchLegacy.complex_query_rate);
          if (first !== undefined) return first;
          return toNumber(searchLegacy.complexQueryRate);
        })(),
        avg_complexity_confidence: (function () {
          const first = toNumber(searchLegacy.avg_complexity_confidence);
          if (first !== undefined) return first;
          return toNumber(searchLegacy.avgComplexityConfidence);
        })(),
        avg_results_per_search: (function () {
          const first = toNumber(searchLegacy.avg_results_per_search);
          if (first !== undefined) return first;
          return toNumber(searchLegacy.avgResultsPerSearch);
        })(),
        upgrade_rate: (function () {
          const first = toNumber(searchLegacy.upgrade_rate);
          if (first !== undefined) return first;
          return toNumber(searchLegacy.upgradeRate);
        })()
      };

      // External targets
      let externalTargets = [];
      if (legacy.external && Array.isArray(legacy.external.targets)) {
        externalTargets = legacy.external.targets;
      } else if (legacy.external_requests && Array.isArray(legacy.external_requests.targets)) {
        externalTargets = legacy.external_requests.targets;
      }

      // Performance
      const performanceBlock = legacy.performance || {};

      // System / platform controls
      let breakerStats = {};
      if (legacy.system && legacy.system.breaker) {
        breakerStats = legacy.system.breaker;
      } else if (legacy.breaker && legacy.breaker.byTarget) {
        breakerStats = legacy.breaker.byTarget;
      }
      let rateLimitStats = {};
      if (legacy.system && legacy.system.rate_limit) {
        rateLimitStats = legacy.system.rate_limit;
      } else if (legacy.rate_limit && legacy.rate_limit.byTarget) {
        rateLimitStats = legacy.rate_limit.byTarget;
      }

      return {
        pipeline: { stages: pipelineStages, alerts: pipelineAlerts },
        quality: { conversation: conversationMetrics, confidence: confidenceMetrics },
        search: searchMetrics,
        external: { targets: externalTargets },
        meta: legacy.meta || {},
        llm: legacy.llm || {},
        security: legacy.security || {},
        performance: performanceBlock,
        system: { breaker: breakerStats, rate_limit: rateLimitStats }
      };
    }

    function renderSummary(data) {
      clearNode(els.summary);
      const pipelineData = data && data.pipeline ? data.pipeline : {};
      const alertsCount = Array.isArray(pipelineData.alerts) ? pipelineData.alerts.length : 0;
      const stages = Array.isArray(pipelineData.stages) ? pipelineData.stages : [];
      const avgSuccess = stages.length
        ? stages.reduce((sum, s) => {
            const totals = s.totals || {};
            const total = (totals.success || 0) + (totals.clarify || 0) + (totals.fail || 0) + (totals.escalated || 0);
            return sum + (total ? totals.success / total : 0);
          }, 0) / stages.length
        : null;
      const searchData = data && data.search ? data.search : {};
      const upgradeRate = typeof searchData.upgrade_rate === 'number' ? searchData.upgrade_rate : null;
      const latencyBlock = data && data.performance && data.performance.e2e_latency_ms ? data.performance.e2e_latency_ms : null;
      const avgLatency = latencyBlock && typeof latencyBlock.avg_ms === 'number' ? latencyBlock.avg_ms : null;

      const summaryItems = [
        {
          label: 'Pipeline success',
          value: avgSuccess !== null ? formatPercent(avgSuccess) : '—',
          caption: avgSuccess !== null ? 'Avg success across active stages' : 'Awaiting production traffic',
          tone: avgSuccess !== null && avgSuccess >= 0.95 ? 'positive' : avgSuccess !== null && avgSuccess < 0.9 ? 'critical' : ''
        },
        {
          label: 'Active alerts',
          value: alertsCount.toString(),
          caption: alertsCount ? 'Review incident log immediately' : 'All clear',
          tone: alertsCount ? 'critical' : 'positive'
        },
        {
          label: 'Avg response',
          value: formatMilliseconds(avgLatency),
          caption: 'End-to-end response time',
          tone: avgLatency !== null && avgLatency > 5000 ? 'critical' : avgLatency !== null && avgLatency > 3500 ? 'warn' : ''
        },
        {
          label: 'Search upgrade rate',
          value: upgradeRate !== null ? formatPercent(Number(upgradeRate)) : '—',
          caption: 'Share of queries requiring deep research',
          tone: upgradeRate !== null && Number(upgradeRate) > 0.35 ? 'warn' : ''
        }
      ];

      summaryItems.forEach((item) => {
        const card = document.createElement('div');
        card.className = 'summary-card';
        if (item.tone === 'positive') card.classList.add('summary-card--positive');
        if (item.tone === 'critical') card.classList.add('summary-card--critical');
        const labelEl = document.createElement('span');
        labelEl.className = 'summary-card__label';
        labelEl.textContent = item.label;
        const valueEl = document.createElement('span');
        valueEl.className = 'summary-card__value';
        valueEl.textContent = item.value;
        const captionEl = document.createElement('span');
        captionEl.className = 'summary-card__caption';
        captionEl.textContent = item.caption;
        card.append(labelEl, valueEl, captionEl);
        els.summary.appendChild(card);
      });
    }

    function renderAlerts(alerts) {
      if (!alerts || alerts.length === 0) {
        renderEmpty(els.alerts, 'No active alerts. System standing by.');
        return;
      }
      clearNode(els.alerts);
      alerts.forEach((alert) => {
        const item = document.createElement('div');
        item.className = 'alert-item';
        if (alert.level === 'warn') item.classList.add('alert-item--warn');
        const label = document.createElement('span');
        label.className = 'alert-item__label';
        label.textContent = alert.message;
        const meta = document.createElement('span');
        meta.className = 'alert-item__meta';
        meta.textContent = alert.code ? `#${alert.code}` : '';
        item.append(label, meta);
        els.alerts.appendChild(item);
      });
    }

    function renderPipeline(stages) {
      if (!stages || stages.length === 0) {
        renderEmpty(els.pipeline, 'No pipeline activity yet. Trigger user journeys to populate metrics.');
        return;
      }
      clearNode(els.pipeline);
      const sorted = [...stages].sort((a, b) => {
        const ta = a.totals || {};
        const tb = b.totals || {};
        const totalA = (ta.success || 0) + (ta.clarify || 0) + (ta.fail || 0) + (ta.escalated || 0);
        const totalB = (tb.success || 0) + (tb.clarify || 0) + (tb.fail || 0) + (tb.escalated || 0);
        const rateA = totalA ? (ta.success || 0) / totalA : 0;
        const rateB = totalB ? (tb.success || 0) / totalB : 0;
        return rateA - rateB;
      });
      sorted.forEach((stage) => {
        const totals = stage.totals || {};
        const total = (totals.success || 0) + (totals.clarify || 0) + (totals.fail || 0) + (totals.escalated || 0);
        const successRate = total ? (totals.success || 0) / total : 0;
        const latency = stage.latency && typeof stage.latency.p95 === 'number' ? stage.latency.p95 : null;
        const card = document.createElement('article');
        card.className = 'pipeline-card';

        const title = document.createElement('div');
        title.className = 'pipeline-card__title';
        const stageEl = document.createElement('span');
        stageEl.className = 'pipeline-card__stage';
        stageEl.textContent = stage.stage || 'unknown';
        const meta = document.createElement('span');
        meta.className = 'pipeline-card__meta';
        meta.textContent = stage.intent ? `Intent · ${stage.intent}` : 'Unclassified intent';
        title.append(stageEl, meta);

        const progress = document.createElement('div');
        progress.className = 'progress';
        const bar = document.createElement('div');
        bar.className = 'progress__bar';
        const barValue = document.createElement('div');
        barValue.className = 'progress__value';
        barValue.style.width = `${Math.round(successRate * 100)}%`;
        if (successRate < 0.9) {
          progress.classList.add('progress--critical');
        } else if (successRate < 0.95) {
          progress.classList.add('progress--warn');
        }
        bar.appendChild(barValue);
        const progressLabel = document.createElement('span');
        progressLabel.className = 'progress__label';
        progressLabel.textContent = formatPercent(successRate);
        progress.append(bar, progressLabel);

        const metrics = document.createElement('div');
        metrics.className = 'metric-list';
        metrics.appendChild(createMetricRow('Volume', formatNumber(total)));
        metrics.appendChild(createMetricRow('Clarifications', formatNumber(totals.clarify || 0)));
        metrics.appendChild(createMetricRow('Failures', formatNumber(totals.fail || 0), totals.fail ? 'critical' : 'positive'));
        metrics.appendChild(createMetricRow('p95 latency', formatMilliseconds(latency), latency !== null && latency > 5000 ? 'critical' : latency !== null && latency > 2500 ? 'warn' : ''));

        card.append(title, progress, metrics);
        els.pipeline.appendChild(card);
      });
    }

    function renderMeta(meta, llm, security) {
      // Routing & tokens
      clearNode(els.metaRouting);
      if (meta && typeof meta.route_confidence === 'number') {
        els.metaRouting.appendChild(createMetricRow('Route confidence', formatPercent(meta.route_confidence)));
      }
      if (meta && meta.tokens) {
        els.metaRouting.appendChild(createMetricRow('Tokens in', formatNumber(meta.tokens.in || 0)));
        els.metaRouting.appendChild(createMetricRow('Tokens out', formatNumber(meta.tokens.out || 0)));
      }
      if (meta && typeof meta.citations_count === 'number') {
        els.metaRouting.appendChild(createMetricRow('Citations (turn)', formatNumber(meta.citations_count)));
      }
      if (meta && meta.verification_runs) {
        const v = meta.verification_runs;
        const total = (v.pass||0)+(v.warn||0)+(v.fail||0);
        if (total>0) {
          els.metaRouting.appendChild(createMetricRow('Verify pass', formatPercent((v.pass||0)/total), (v.pass||0)/total<0.9?'warn':'positive'));
          els.metaRouting.appendChild(createMetricRow('Verify fail', formatPercent((v.fail||0)/total), (v.fail||0)>0?'critical':''));
        }
      }
      if (meta && meta.routing_decision) {
        const entries = Object.entries(meta.routing_decision).sort((a,b)=>b[1]-a[1]).slice(0,3);
        entries.forEach(([intent,count])=>{
          els.metaRouting.appendChild(createMetricRow(`Route · ${intent}`, formatNumber(count)));
        });
      }

      // Tools usage & errors
      clearNode(els.metaTools);
      if (meta && meta.tool_calls) {
        const topCalls = Object.entries(meta.tool_calls).sort((a,b)=>b[1]-a[1]).slice(0,5);
        topCalls.forEach(([tool,count])=>{
          els.metaTools.appendChild(createMetricRow(`Calls · ${tool}`, formatNumber(count)));
        });
      }
      if (meta && meta.tool_errors) {
        const byTool = meta.tool_errors;
        Object.entries(byTool).slice(0,3).forEach(([tool, errs])=>{
          const sum = Object.values(errs).reduce((a,b)=>a+b,0);
          els.metaTools.appendChild(createMetricRow(`Errors · ${tool}`, formatNumber(sum), sum>0?'warn':''));
        });
      }
      if (meta && meta.ledger && meta.ledger.skipped_by_ledger_by_tool) {
        const entries = Object.entries(meta.ledger.skipped_by_ledger_by_tool).sort((a,b)=>b[1]-a[1]).slice(0,3);
        entries.forEach(([tool,count])=>{
          els.metaTools.appendChild(createMetricRow(`Skipped (ledger) · ${tool}`, formatNumber(count)));
        });
      }

      // LLM latency + security
      clearNode(els.metaLLM);
      if (llm && llm.request_latency_ms) {
        const items = Object.entries(llm.request_latency_ms).sort((a,b)=> (b[1].count||0)-(a[1].count||0)).slice(0,5);
        items.forEach(([key, agg])=>{
          const label = key.replace(/:[^:]*:(\w+)$/, ' · $1');
          els.metaLLM.appendChild(createMetricRow(`${label}`, `${formatMilliseconds(agg.avg)} avg / ${formatMilliseconds(agg.max)} max (${formatNumber(agg.count)}x)`));
        });
      } else {
        renderEmpty(els.metaLLM, 'No LLM latency yet.');
      }
      if (security && security.web_allowlist_blocks) {
        const totalBlocks = Object.values(security.web_allowlist_blocks).reduce((a,b)=>a+b,0);
        if (totalBlocks>0) els.metaLLM.appendChild(createMetricRow('Allowlist blocks', formatNumber(totalBlocks), 'warn'));
      }
      if (security && security.sanitization_actions) {
        const totalSan = Object.values(security.sanitization_actions).reduce((a,b)=>a+b,0);
        if (totalSan>0) els.metaLLM.appendChild(createMetricRow('Sanitizations', formatNumber(totalSan)));
      }
    }

    function renderConversation(conversation) {
      if (!Array.isArray(conversation) || conversation.length === 0) {
        renderEmpty(els.conversation, 'No conversation quality data yet.');
        return;
      }
      clearNode(els.conversation);
      conversation.forEach((metric) => {
        const tone = metric.tone || '';
        let rawValue = metric.value;
        if (rawValue === undefined || rawValue === null) rawValue = metric.percentage;
        if (rawValue === undefined || rawValue === null) rawValue = metric.count;
        const formatted = metric.format === 'percent' ? formatPercent(rawValue) : formatNumber(rawValue);
        els.conversation.appendChild(createMetricRow(metric.label || metric.metric || 'Metric', formatted, tone));
      });
    }

    function renderConfidence(confidence) {
      if (!Array.isArray(confidence) || confidence.length === 0) {
        renderEmpty(els.confidence, 'Waiting for confidence calibration data.');
        return;
      }
      clearNode(els.confidence);
      confidence.forEach((entry) => {
        if (entry.high && entry.high.total > 0) {
          const tone = entry.high.success_rate < 0.8 ? 'critical' : '';
          els.confidence.appendChild(createMetricRow(`${entry.stage}/${entry.intent} · High`, formatPercent(entry.high.success_rate), tone));
        }
        if (entry.low && entry.low.total > 0) {
          const tone = entry.low.success_rate > 0.6 ? 'positive' : 'warn';
          els.confidence.appendChild(createMetricRow(`${entry.stage}/${entry.intent} · Low`, formatPercent(entry.low.success_rate), tone));
        }
      });
    }

    function renderSearch(search) {
      if (!search || !search.total) {
        renderEmpty(els.search, 'No web search calls yet. Run blended queries to populate metrics.');
        return;
      }
      clearNode(els.search);
      els.search.appendChild(createMetricRow('Total searches', formatNumber(search.total)));
      if (search.complex_query_rate !== undefined) {
        els.search.appendChild(createMetricRow('Complex query rate', formatPercent(search.complex_query_rate), search.complex_query_rate > 0.4 ? 'warn' : ''));
      }
      if (search.avg_complexity_confidence !== undefined) {
        els.search.appendChild(createMetricRow('Avg complexity confidence', Number(search.avg_complexity_confidence).toFixed(2)));
      }
      if (search.avg_results_per_search !== undefined) {
        els.search.appendChild(createMetricRow('Avg results per search', Number(search.avg_results_per_search).toFixed(1)));
      }
      if (search.upgrade_rate !== undefined) {
        els.search.appendChild(createMetricRow('Upgrade rate', formatPercent(Number(search.upgrade_rate)), Number(search.upgrade_rate) > 0.35 ? 'warn' : ''));
      }
    }

    function renderExternal(external) {
      const targets = external && Array.isArray(external.targets) ? external.targets : [];
      if (!targets.length) {
        renderEmpty(els.external, 'No partner activity yet. External services are idle.');
        return;
      }
      clearNode(els.external);
      targets.forEach((target) => {
        const latency = target.latency && typeof target.latency.avg_ms === 'number' ? target.latency.avg_ms : null;
        const tone = latency !== null && latency > 5000 ? 'critical' : latency !== null && latency > 2500 ? 'warn' : '';
        els.external.appendChild(createMetricRow(`${target.target} · avg latency`, formatMilliseconds(latency), tone));
        if (target.byContext) {
          const contexts = Object.entries(target.byContext)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3);
          contexts.forEach(([context, count]) => {
            els.external.appendChild(createMetricRow(`› ${context}`, formatNumber(count)));
          });
        }
      });
    }

    function renderPerformance(performance) {
      const latency = performance && performance.e2e_latency_ms ? performance.e2e_latency_ms : null;
      if (!latency) {
        renderEmpty(els.performance, 'No performance telemetry captured yet.');
        return;
      }
      clearNode(els.performance);
      const avgTone = latency.avg_ms > 5000 ? 'critical' : latency.avg_ms > 3500 ? 'warn' : 'positive';
      els.performance.appendChild(createMetricRow('Avg response time', formatMilliseconds(latency.avg_ms), avgTone));
      els.performance.appendChild(createMetricRow('Min response', formatMilliseconds(latency.min_ms)));
      els.performance.appendChild(createMetricRow('Max response', formatMilliseconds(latency.max_ms)));
      els.performance.appendChild(createMetricRow('Total requests', formatNumber(latency.count)));
    }

    function renderSystem(system) {
      const breaker = system && system.breaker ? system.breaker : {};
      const rate = system && system.rate_limit ? system.rate_limit : {};
      const entries = [];

      Object.entries(breaker).forEach(([target, status]) => {
        const state = status.state || 'unknown';
        const tone = state === 'closed' ? 'positive' : 'warn';
        entries.push({ label: `${target} circuit`, value: state === 'closed' ? 'Healthy' : state, tone });
      });

      Object.entries(rate).forEach(([target, limits]) => {
        if ((limits.queued_current || 0) > 0) {
          entries.push({ label: `${target} queued`, value: formatNumber(limits.queued_current), tone: 'warn' });
        }
      });

      if (!entries.length) {
        renderEmpty(els.system, 'All platform controls healthy.');
        return;
      }

      clearNode(els.system);
      entries.forEach((entry) => {
        els.system.appendChild(createMetricRow(entry.label, entry.value, entry.tone));
      });
    }

    async function fetchMetrics() {
      setStatus('loading', 'Refreshing…');
      try {
        const response = await fetch(API_ENDPOINT, { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`Request failed with status ${response.status}`);
        }
        let payload = await response.json();
        payload = adaptLegacyPayload(payload);

        renderSummary(payload);
        renderAlerts(payload.pipeline && payload.pipeline.alerts);
        renderPipeline(payload.pipeline && payload.pipeline.stages);
        renderConversation(payload.quality && payload.quality.conversation);
        renderConfidence(payload.quality && payload.quality.confidence);
        renderSearch(payload.search);
        renderExternal(payload.external);
        renderMeta(payload.meta, payload.llm, payload.security);
        renderPerformance(payload.performance);
        renderSystem(payload.system);

        setStatus('ok', 'Connected');
        const now = new Date();
        els.lastUpdated.textContent = `Last updated ${now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
      } catch (error) {
        console.error('Failed to load metrics', error);
        setStatus('critical', 'Error fetching metrics');
        els.lastUpdated.textContent = 'Last updated —';
        renderEmpty(els.summary, 'Unable to load metrics. Check API availability.');
        renderEmpty(els.alerts, error.message || 'Metrics endpoint unavailable.');
        [els.pipeline, els.conversation, els.confidence, els.search, els.external, els.performance, els.system].forEach((node) => {
          renderEmpty(node, '—');
        });
      }
    }

    function handleAutoRefreshToggle() {
      if (els.autoRefresh.checked) {
        autoRefreshTimer = setInterval(fetchMetrics, REFRESH_INTERVAL_MS);
      } else {
        clearInterval(autoRefreshTimer);
      }
    }

    function init() {
      document.getElementById('footerYear').textContent = new Date().getFullYear();
      els.refreshBtn.addEventListener('click', fetchMetrics);
      els.autoRefresh.addEventListener('change', handleAutoRefreshToggle);
      fetchMetrics();
      handleAutoRefreshToggle();
    }

    init();
  </script>
</body>
</html>
